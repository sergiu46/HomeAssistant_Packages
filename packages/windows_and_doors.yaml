# Version: 2023.10.2
# Open Windows Package
# This package create a sensor with number of open windows
#
# If you want to exlcude entities create an imput select helper named: "ΙΙ Ignored Doors" 
# for doors or "ΙΙ Ignored Windows" for windows
# and add all entity id's that you want to exclude as options.
#


script:
  # Script to update this package from GitHub
  update_packages:
    sequence:
      - service: downloader.download_file
        data:
          overwrite: true
          url: >-
            {% set url = 'https://raw.githubusercontent.com/' %}
            {% if states.input_text.packages_account.state is defined %}
              {% set account = states('input_text.packages_account') %}
            {% else %}
              {% set account = 'topaniot' %}
            {% endif %}
            {% set path = '/HomeAssistant_Packages/main/packages/' %}
            {% set name = 'windows_and_doors.yaml' %}
            {{ url + account + path + name }}


template:
  - trigger:
      - platform: time_pattern
        seconds: "/1"
    sensor:
      - name: "Open Windows"
        icon: "hass:window-open"
        state: >
              {% if states.input_select.ignored_windows.state is defined %}
                {% set ignored = state_attr('input_select.ignored_windows','options') %}
              {% else %}
                {% set ignored = [] %}
              {% endif %}
              {{ states.binary_sensor
                |selectattr('attributes.device_class','defined')
                |selectattr('attributes.device_class','eq','window')
                |rejectattr('state', 'in', ['off','unknown','unavailable','none'])
                |rejectattr('entity_id','in', ignored )
                |list|count 
              }}
        attributes:
            names: >
              {% if states.input_select.ignored_windows.state is defined %}
                {% set ignored = state_attr('input_select.ignored_windows','options') %}
              {% else %}
                {% set ignored = [] %}
              {% endif %}

              {{ states.binary_sensor
                |selectattr('attributes.device_class','defined')
                |selectattr('attributes.device_class','eq','window')
                |rejectattr('state', 'in', ['off','unknown','unavailable','none'])
                |rejectattr('entity_id','in', ignored )
                |map(attribute='name')|join (", ")
              }}

      - name: "Open Doors"
        icon: "hass:door-open"
        state: >
              {% if states.input_select.ignored_doors.state is defined %}
                {% set ignored = state_attr('input_select.ignored_doors','options') %}
              {% else %}
                {% set ignored = [] %}
              {% endif %}
              
              {{ states.binary_sensor
                |selectattr('attributes.device_class','defined')
                |selectattr('attributes.device_class','eq','door')
                |rejectattr('state', 'in', ['off','unknown','unavailable','none'])
                |rejectattr('entity_id','in', ignored )
                |list|count 
              }}
        attributes:
            names: >
              {% if states.input_select.ignored_doors.state is defined %}
                {% set ignored = state_attr('input_select.ignored_doors','options') %}
              {% else %}
                {% set ignored = [] %}
              {% endif %}
              
              {{ states.binary_sensor
                |selectattr('attributes.device_class','defined')
                |selectattr('attributes.device_class','eq','door')
                |rejectattr('state', 'in', ['off','unknown','unavailable','none'])
                |rejectattr('entity_id','in', ignored )
                |map(attribute='name')|join (", ")
              }}
